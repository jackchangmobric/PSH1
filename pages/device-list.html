<div data-page='device-list' class='page navbar-fixed'>
    <style>
        [data-page='device-list'] .accessory i {
            border-radius: 17px;
            background: white;
            width: 17px;
            height: 17px;
            text-align: center;
            padding: 4px;
            font-size: 24px;
            line-height: 17px;
            box-shadow: 0px 0px 4px 4px rgba(91, 142, 236, 0.3);
        }
        [data-page='device-list'] .gateway-item .name {
            display: inline-block;
        }
        [data-page='device-list'] .gateway-item .mac, 
        [data-page='device-list'] .device-item .mac {
            color: #CCC;
            position: absolute;
            right: 48px;
            font-size: 14px;
        }
        [data-page='device-list'] .gateway-item .item-content {
            padding-left: 32px;
            background-position: left;
            background-repeat: no-repeat;
            background-size: 24px;
            background-image: url(img/icons/sb_03.png) !important;
        }
        [data-page='device-list'] .device-item .item-content {
            padding-left: 32px;
            padding-left: 32px;
            background-position: left;
            background-repeat: no-repeat;
            background-size: 24px;
            background-image: url(img/icons/sb_11.png) !important;
        }
        [data-page='device-list'] .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 12px;
            background: white;
        }
        [data-page='device-list'] .connection-status[data-status=unknown] {
            background: gray;
        }
        [data-page='device-list'] .connection-status[data-status=offline] {
            background: red;
        }
        [data-page='device-list'] .connection-status[data-status=online] {
            background: lightgreen;
        }
        [data-page='device-list'] .connection-status[data-status=connecting] {
            background: orange;
        }
        [data-page='device-list'] .connection-status[data-status=initializing] {
            background: lightblue;
        }
        [data-page='device-list'] .accessory {
            float: right;
            color: #88F;
        }
    </style>
    <script>
        $page.onload(function() {
            $gateway.watch(function(type, devices) {
                Object.keys(devices).forEach(function(mac) {
                    var el = $('#m' + mac);
                    if (!el) { return; }

                    var status = $(el, '.connection-status');
                    if (!status) { return; }

                    status.setAttribute('data-status', 'online');
                });
            });
        });
        $page.onload(function() {
            // $('#db-log').innerHTML += 'pre-reload<br>';
            var reload = function() {
                var entries = [];
                // $('#db-log').innerHTML += 'pre-reload1<br>';
                try {

                Object.keys($db.gateways).forEach(function(mac) {
                    var gateway = $db.gateways[mac];
                    var info = {
                        name: gateway.name,
                        mac: gateway.mac,
                        status: $gateway.status(mac),
                        '::delete': 'delete'
                    };
                    entries.push($templates('#gateway-item', info));
                });
                } catch (e) {
                // $('#db-log').innerHTML += (e + '<br>');
                }

                // $('#db-log').innerHTML += 'pre-reload2<br>';
                $('#gateway-list-inner').innerHTML = entries.join('');
                // $('#db-log').innerHTML += 'pre-reload3<br>';
                $page.onload(function() {
                    $('#gateway-list-inner .gateway-item .item-content', true).forEach(function(i) {
                        var mac = $(i, '.mac').innerHTML;
                        i.onclick = function() {
                            $mainView.router.loadPage('pages/new-gateway.html?mac=' + mac);
                        };
                    });
                });
                // $('#db-log').innerHTML += 'pre-reload4<br>';
            };
            $gateway.changed(function() {
                // $('#db-log').innerHTML += 'changed<br>';
                reload();
            });
            reload();
            // $('#db-log').innerHTML += 'reload<br>';

            $$('.gateway-item.swipeout').on('swipeout:deleted', function(e) {
                $db.gateways.$update(function(tbl) {
                    delete tbl[$(e.target, '.mac').innerHTML];
                }).$save();
            }); 
        });
        $page.onload(function() {
            var reload = function() {
                var entries = [];
                Object.keys($db.devices).forEach(function(mac) {
                    var dev = $db.devices[mac];
                    var info = {
                        mac: mac,
                        name: dev.name || mac,
                        status: 'offline',
                        '::delete': 'delete'
                    };
                    entries.push($templates('#device-item', info));
                });
                $('#device-list-inner').innerHTML = entries.join('');
                $page.onload(function() {
                    $('#device-list-inner .device-item .item-content', true).forEach(function(i) {
                        var mac = $(i, '.mac').innerHTML;
                        i.onclick = function() {
                            $mainView.router.loadPage('pages/new-device.html?mac=' + mac);
                        };
                    });
                });
            };
            $gateway.changed(function(gmac) {
                console.info(gmac);
                if ($gateway.online(gmac)) { return; }

                $gateway.each(function(type, mac, dev) {
                    console.info(dev.gateway + ' | ' + gmac);
                    return dev.gateway === gmac;
                }, function(type, mac, dev) {
                    var el = $('#m' + mac);
                    if (!el) { return; }

                    var status = $(el, '.connection-status');
                    if (!status) { return; }

                    status.setAttribute('data-status', 'offline');                    
                });
            });
            reload();

            $$('.device-item.swipeout').on('swipeout:deleted', function (e) {
                $db.devices.$update(function(tbl) {
                    delete tbl[$(e.target, '.mac').innerHTML];
                }).$save();
            }); 
        });
        $page.onload(function() {
            $('#add-new-gateway').onclick = function() {
                $mainView.router.loadPage('pages/new-gateway.html');
            };
        });
        $page.onload(function() {
            $('#add-new-device').onclick = function() {
                $mainView.router.loadPage('pages/new-device.html');
            };
        });
    </script>

    <script id="gateway-item" type="text/template7"><li class="gateway-item swipeout">
        <div class="swipeout-content item-content">
            <div class="item-inner"><span class='name'>{{name}}</span><span class='mac'>{{mac}}</span><span class='connection-status' data-status='{{status}}'></span></div>
        </div>
        <div class="swipeout-actions-right">
            <a href="#" class="swipeout-delete">{{delete}}</a>
        </div>
    </li></script>

    <script id="device-item" type="text/template7"><li class="device-item swipeout" id='m{{mac}}'>
        <div class="swipeout-content item-content">
            <div class="item-inner"><span class='name'>{{name}}</span><span class='mac'>{{mac}}</span><span class='connection-status' data-status='{{status}}'></span></div>
        </div>
        <div class="swipeout-actions-right">
            <a href="#" class="swipeout-delete">{{delete}}</a>
        </div>
    </li></script>

<div class="navbar">
    <div class="navbar-inner">
        <div class="left"><a class='link' href='pages/room-list.html'><i class='icon f7-icons'>chevron_left</i><span data-i18n-key='back'></span></a></div>
        <div class="center" id='title' data-i18n-key='page-title'></div>
        <div class="right"></div>
    </div>
</div>

<div class='page-content' style='overflow-y: auto'>
    <div class="content-block-title">
        <span data-i18n-key='gateways'></span>
        <span class='accessory' id='add-new-gateway'><i class='icon f7-icons'>add</i></span>
    </div>
    <div class="list-block"><ul id='gateway-list-inner'></ul></div>

    <div class="content-block-title">
        <span data-i18n-key='devices'></span>
        <span class='accessory' id='add-new-device'><i class='icon f7-icons'>add</i></span>
    </div>
    <div class="list-block"><ul id='device-list-inner'></ul></div>
    <div class='list-block' id='db-log'></div>
</div>

<script>
    // $('#db-log').innerHTML = JSON.stringify(window.localStorage);
    // setInterval(function() {
        // $('#db-log').innerHTML = JSON.stringify($gateway.dump(1));
    // }, 1000);
</script>

</div>