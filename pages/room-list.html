<div data-page='room-list' class='page navbar-fixed'>
    <script>
        $page.onload(function() { setTimeout(function() {
            var gateways = Object.keys($db.gateways);
            if (gateways.length === 0) {
                console.info('new-gateway');
                return $mainView.router.loadPage('pages/new-gateway.html');
            }

            var rooms = Object.keys($db.rooms);
            if (rooms.length === 0) {
                console.info('new-room');
                return $mainView.router.loadPage('pages/new-room.html');
            }

            var devices = Object.keys($db.devices);
            if (rooms.length === 1 && devices.length === 0) {
                console.info('room-view');
                // return $mainView.router.loadPage('pages/room-view.html?rid=' + rooms[0]); 
            }
        }, 1000); });
        $page.onload(function(e) {
            $('#logout').onclick = function() {
                $db.reset();
                setTimeout(function() {                    
                    location.reload();
                }, 300);
            };
        });
        $page.onload(function() {
            var entries = [];
            Object.keys($db.rooms).forEach(function(rid) {
                var room = $db.rooms[rid];
                var info = {
                    rid: rid,
                    name: room.name,
                    w: room.w,
                    d: room.d,
                    icon: room.icon,
                    description: room.description,
                    scene: '',
                    '::delete': 'delete'
                };
                entries.push($templates('#room-item', info));
            });
            $('#room-list-inner').innerHTML = entries.join('');
        });
        $page.onload(function() {
            $$('.room-list-item.swipeout').on('swipeout:deleted', function (e) {
                var rid = e.target.getAttribute('data-room-id');
                $db.rooms.$update(function(tbl) {
                    delete tbl[rid];
                }).$save()
                .then(function() { $db.devices.$update(function(devices) {
                    Object.keys(devices).forEach(function(mac) {
                        if (devices[mac].room === rid) {
                            delete devices[mac].room;
                        }
                    });
                }).$save(); });
            }); 
        });
    </script>

    <script id="room-item" type="text/template7"><li class='swipeout room-list-item' data-room-id='{{rid}}'>
    <a href="pages/room-view.html?rid={{rid}}" class="item-link swipeout-content item-content">
        <div class="item-media"><img style='width:48px' src="img/room-icons/{{icon}}" width="80"></div>
        <div class="item-inner">
            <div class="item-title-row">
                <div class="item-title">{{name}}</div>
                <div class="item-after">{{w}} x {{d}}</div>
            </div>
            <div class="item-subtitle">{{scene}}</div>
            <div class="item-text">{{description}}</div>
        </div>
    </a>
    <div class="swipeout-actions-right">
        <a href="#" class="swipeout-delete">{{delete}}</a>
    </div>
    </li></script>

<div class="navbar">
    <div class="navbar-inner">
        <div class="left"><a class='link' href='#' id='logout'><i class='icon f7-icons'>logout</i></a></div>
        <div class="center"></div>
        <div class="right">
            <a class='link' href='pages/device-list.html' id='open-device-list'><i class='icon f7-icons'>today</i></a>
            <a class='link' href='pages/new-room.html' id='open-new-room'><i class='icon f7-icons'>add_round</i></a>
        </div>
    </div>
</div>

<div class='page-content' style='overflow-y: auto'>
    <div class="list-block media-list"><ul id='room-list-inner'></ul></div>
</div>

</div>