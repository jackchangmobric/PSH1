<div data-page='new-room' class='page navbar-fixed no-toolbar'>
    <style>
        [data-page="new-room"] #dimension span {
          display: inline-block;
          width: 20px
        }
        [data-page="new-room"] #room-information input {
          padding: 0px 8px !important;            
        }
        [data-page="new-room"] #dimension input {
          width: calc(50% - 4px);
          display: inline-block;
        }

        [data-page="new-room"] input[data-error] {
            background-color: #ff9696 !important;
        }
        [data-page="new-room"] #room-icon-list-outer {
            border: none;
        }
        [data-page="new-room"] #room-icon-list {
            overflow-y: hidden;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            line-height: 0px;
        }
        [data-page="new-room"] #room-icon-list img {
            border-radius: 64px;
            width: 64px;
            padding: 8px;
            box-shadow: 0px 0px 4px 4px rgba(180, 180, 180, 0.3);
            margin: 4px 8px;
            opacity: 0.2;
        }
        [data-page="new-room"] #room-icon-list img[data-active] {
            box-shadow: 0px 0px 4px 4px rgba(91, 142, 236, 0.5);
            opacity: 1.0;
        }
        [data-page="new-room"] #device-list .name {
            display: inline;
        }
        [data-page="new-room"] #device-list .mac {
            display: inline;
            margin-left: 0px;
            color: gray;
        }
        [data-page="new-room"] #device-list .room {
            position: absolute;
            right: 16px;
            color: #3f51b5;
            font-size: smaller;
        }
        [data-page="new-room"] .accessory {
            float: right;
            color: #88F;
            line-height: 25px;
        }

        [data-page="new-room"] .item-title[data-i18n-key='name'] {
            padding-left: 32px;
            background-position: left center;
            background-size: 24px;
            background-repeat: no-repeat;
            background-image: url(img/icons/fjsz_03.png);
        }
        [data-page="new-room"] .item-title[data-i18n-key='dimension'] {
            padding-left: 32px;
            background-position: left center;
            background-size: 24px;
            background-repeat: no-repeat;
            background-image: url(img/icons/fjsz_07.png);
        }
        [data-page="new-room"] .item-title[data-i18n-key='description'] {
            padding-left: 32px;
            background-position: left center;
            background-size: 24px;
            background-repeat: no-repeat;
            background-image: url(img/icons/fjsz_10.png);
        }
        [data-page="new-room"] 
    </style>
    <script>
        $page.onload(function() {
            if (Object.keys($db.rooms).length !== 0) {
                return;
            }
            $('#cancel').style.display = 'none';
        });
        $page.onload(function() {
            var l = [];
            for (var i = 1; i <= 5; ++i) {
                l.push('<img src="img/room-icons/' + i + '.png">')
            }
            $('#room-icon-list').innerHTML = l.join('');
        });
        $page.onload(function() {
            var icons = $('#room-icon-list img', true);
            icons.forEach(function(icon) { icon.onclick = function() {
                icons.forEach(function(i) {
                    if (i === icon) { i.setAttribute('data-active', true); }
                    else            { i.removeAttribute('data-active'); }
                });
            }; });
        });
        $page.onload(function(e) {
            var rid = e.query.rid;
            if (!rid) {
                $('[data-i18n-key="edit-room-title"]').style.display = 'none';
                rid = 'r_' + Date.now();
            }
            else {
                $('[data-i18n-key="new-room-title"]').style.display = 'none';
            }
            $('#room-id').value = rid;

            var room = $db.rooms[rid];
            if (!room) { 
                $('#room-icon-list img').onclick();
            }
            else {
                $('#room-information input', true).forEach(function(i) {
                    i.value = room[i.id];
                });
                $('#room-icon-list img', true).forEach(function(i) {
                    if (i.src.indexOf(room.icon) !== -1) {
                        i.onclick();
                    }
                });
                if (!$('#room-icon-list img[data-active]')) {
                    $('#room-icon-list img').onclick();                    
                }
            }
        });
        $page.onload(function(e) {
            $('#cancel').onclick = $('#back-to-prev').onclick = function() {
                var rid = $('#room-id').value;
                console.info(rid);
                if (!$db.rooms[rid] || e.query.list) {
                    return $mainView.router.loadPage('pages/room-list.html');
                }
                else {
                    return $mainView.router.loadPage('pages/room-view.html?rid=' + rid);                    
                }
            };
            $('#save').onclick = function() {
                $('#room-information input', true).forEach(function(i) {
                    if (!i.value) {
                        i.setAttribute('data-error', true);
                    }
                    else {
                        i.removeAttribute('data-error'); 
                    }
                });

                if ($('#room-information input[data-error]', true).length) {
                    return;
                }

                var rid = $('#room-id').value;
                var selections = $('#device-list input', true)
                    .reduce(function(p, i) { 
                        p[i.value] = i.checked;
                        return p;
                    }, {});
                $db.devices.$update(function(o) {
                    Object.keys(selections).forEach(function(mac) {
                        var dev = o[mac];
                        if (!selections[mac]) {
                            if (dev.room === rid) {
                                dev.room = '';
                                dev.x = null;
                                dev.y = null;
                            }
                        }
                        else if (dev.room !== rid) {
                            dev.room = rid;
                            dev.x = null;
                            dev.y = null;
                        }
                    });
                }).$save()
                .then(function() {
                    return $db.rooms.$update(function(o) {
                        if (!rid) { return; }

                        var r = (o[rid]) || (o[rid] = {});
                        var img = $('#room-icon-list img[data-active]').src;
                        var idx = img.lastIndexOf('/');
                        $('#room-information input', true).forEach(function(i) {
                            r[i.id] = i.value;
                        });
                        r.icon = img.substr(idx + 1);
                    }).$save(); 
                })
                .then(function() {
                    if (e.query.list) {
                        return $mainView.router.loadPage('pages/room-list.html');
                    }
                    else {
                        return $mainView.router.loadPage('pages/room-view.html?rid=' + rid);                         
                    }
                });
            };
        });
        $page.onload(function() {
            $('#select-all').onclick = function() {
                $('#device-list input', true).forEach(function(i) {
                    i.checked = true;
                });
                $('#select-all').style.display = 'none';
                $('#deselect-all').style.display = 'inline';
            };
            $('#deselect-all').onclick = function() {
                $('#device-list input', true).forEach(function(i) {
                    i.checked = false;
                });
                $('#select-all').style.display = null;
                $('#deselect-all').style.display = 'none';
            };
        });
        $page.onload(function() {
            var rid = $('#room-id').value;
            var entries = [];
            Object.keys($db.devices).sort(function(a, b) {
                var ra = $db.devices[a].room || '';
                var rb = $db.devices[b].room || '';
                return ra.localeCompare(rb);
            })
            .forEach(function(mac) {
                var dev = $db.devices[mac];
                var room = (dev.room) ? $db.rooms[dev.room] : null;
                entries.push($templates('#device-select', {
                    mac: mac,
                    room: (room) ? room.name : '',
                    name: dev.name,
                    showMAC: (dev.name) ? 'display:none' : '',
                    checked: (rid === dev.room) ? 'checked' : ''
                }));
            });
            $('#device-list').innerHTML = entries.join('');
        });
    </script>

    <script id="device-select" type="text/template7">
        <li data-dev-id='m_{{mac}}'>
            <label class="label-checkbox item-content">
            <input type="checkbox" name="{{mac}}" value="{{mac}}" {{checked}}>
                <div class="item-media"><i class="icon icon-form-checkbox"></i></div>
                <div class="item-inner">
                    <div class="item-title">
                        <span class='name'>{{type}} {{name}}</span>
                        <span class='mac' style='{{showMAC}}'>{{mac}}</span>
                    </div>
                    <span class='room'>{{room}}</span>
                </div>
            </label>
        </li>
    </script>

    <div class="navbar">
        <div class="navbar-inner">
            <div class="left"><a class='link' id='back-to-prev' href='#'><i class='icon f7-icons'>chevron_left</i><span data-i18n-key='back'></span></a></div>
            <div class="center"><span data-i18n-key='new-room-title'></span><span data-i18n-key='edit-room-title'></span></div>
            <div class="right"></div>
        </div>
    </div>

    <div class='page-content'>
        <div class="content-block-title" data-i18n-key='room-information'></div>
        <input type='hidden' id='room-id'>
        <div class='list-block' id='room-information'>
            <ul>
                <li><div class='item-content'>
                    <div class='item-inner'>
                        <div class='item-title label' data-i18n-key='name'></div>
                        <div class='item-input'>
                            <input type='text' id='name' data-i18n-key='empty-name:placeholder'>
                        </div>
                    </div>
                </div></li>
                <li><div class='item-content'>
                    <div class='item-inner' id='dimension'>
                        <div class='item-title label' data-i18n-key='dimension'></div>
                        <div class='item-input'>
                            <input type='number' id='w' data-i18n-key='dimensionW:placeholder'>
                            <input type='number' id='d' data-i18n-key='dimensionD:placeholder'>
                        </div>
                    </div>
                </div></li>
                <li><div class='item-content'>
                    <div class='item-inner'>
                        <div class='item-title label' data-i18n-key='description'></div>
                        <div class='item-input'>
                            <input type='text' id='description' data-i18n-key='empty-description:placeholder'>
                        </div>
                    </div>
                </div></li>
            </ul>
        </div>
        <div class="content-block-title" data-i18n-key='room-icon'></div>
        <div class='list-block'><div class='item-content' id='room-icon-list-outer'><div id='room-icon-list'></div></div></div>

        <div class="content-block-title"><span data-i18n-key='device-list'></span>
            <span class='accessory' id='select-all' data-i18n-key='select-all'></span>
            <span class='accessory' id='deselect-all' data-i18n-key='unselect-all' style='display:none'></span>
        </div>
        <div class='list-block'><ul id='device-list'></ul></div>

        <div class='content-block'>
            <p class="buttons-row">
                <a href="#" id='cancel' class="button button-raised link" data-i18n-key='cancel'></a>
            </p>
            <p class="buttons-row">
                <a href="#" id='save' class="button button-fill button-raised link" data-i18n-key='done'></a>
            </p>
        </div>
    </div>
</div>