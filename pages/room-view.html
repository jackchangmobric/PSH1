<div data-page='room-view' class='page navbar-fixed'>
<style>
    @keyframes wiggle {
        0% { transform: rotate(0deg); }
        8% { transform: rotate(-10deg); }
        16% { transform: rotate(0deg); }
        24% { transform: rotate(10deg); }
        32% { transform: rotate(0deg); }
        40% { transform: rotate(-10deg); }
        48% { transform: rotate(0deg); }
        56% { transform: rotate(10deg); }
        100% { transform: rotate(0deg); }
    }
    .device-icon {
        z-index: 10;
        top: 0px;
        position: absolute;
        display: block;
        width: calc(100% - 10px);
        height: calc(100% - 8px);
        border-radius: 4px;
        margin: 4px;
        /*box-shadow: 2px 2px 6px gray;*/
        background: none !important;
    }
    .device-icon .center {
        width: 36%;
        height: 36%;
        margin: 32%;
        border-radius: 100%;
        display: inline-block;
        position: absolute;
        border: thin solid lightgrey;
        /*box-shadow: 2px 2px 8px gray;*/
    }
    .device-icon i.fa {
        position:absolute;
        top:50%;
        width:100%;
        transform:translate(0,-50%);
        text-align:center;
        font-size: 70%;
        text-shadow: 2px 2px 8px gray;
    }
    #room-grid-outer {
        position:absolute;
        top:0px;
        bottom:0px;
        left:0px;
        right:0px;
        overflow-y:auto;
        /*padding-top: 32px;*/
        padding: 32px 8px 0px 8px;
    }
    #room-grid {
        width: 100%;
        margin: 48px 0px 96px 0px;
        table-layout: fixed;
        border: 3px solid #444;
        border-collapse: collapse;
        border-spacing: 0px;
        transform-origin: top left;
    }
    #room-grid td {
        padding: 0px;
        overflow: hidden;
        border: thin dashed #CCC;
        white-space: nowrap;
        position: relative;
        overflow: visible;
    }
    [data-page="room-view"][data-editable] #room-grid .device-icon {
        animation: wiggle 1s infinite;  
    }
    [data-page="room-view"][data-editable] #room-grid, 
    [data-page="room-view"][data-editable] #room-grid td {
        border-color: #f44336;
        border-style: dotted;
    }
    [data-page="room-view"][data-editable] .device-icon {
        /*box-shadow: 4px 2px 4px #53a8fe;*/
    }

    [data-page="room-view"][data-editable] .navbar .link {
        display: none;
    }

    #edit-done-panel {
        background-color: rgba(255,255,255,0.9);
        height: auto;
        box-shadow: -2px -2px 4px lightgray;
    }
    #show-saved-modes {
        z-index: 90;
        position: absolute;
        left: calc(50% - 48px);
        bottom: 0px;
        min-width: 96px;
        height: 48px;
        font-weight: bold;
        margin: 0px auto;
        border-radius: 96px 96px 0px 0px;
        padding: 8px 0px 0px 0px;
        box-shadow: 2px 2px 6px gray;
    }
    #show-saved-modes > * {
        font-size: 36px;
    }
    #saved-modes-panel {
        height: auto;
        box-shadow: 2px -2px 4px lightgrey;
        background-color: rgba(255,255,255,0.9);
    }
    #saved-modes-panel > .picker-modal-inner {
        line-height: 1em;
        /*padding: 16px;*/
    }
    #saved-modes-panel .saved-mode-group {
        border-right: thin solid lightgrey;
        display: inline-block;
        padding: 24px 16px;
        vertical-align: top;
        height: 48px;
    }
    #saved-modes-panel .saved-mode-group:empty {
        display: none;
    }
    #saved-modes-panel .saved-mode-group:last-child {
        float: right;
        border: none;
    }
    #saved-modes-panel .saved-mode {
        background: darkgray;
        display: inline-block;
        border-radius: 48px;
        height: 48px;
        width: 48px;
        padding: 0px;
        /*box-shadow: 2px 2px 6px gray;*/
        font-size: 32px;
        margin: 0px 8px;
        text-align: center;
    }
    #saved-modes-panel a i {
        color: white;
        line-height: 48px;
    }

    #picker-lighting {
        background-color: rgba(255,255,255,0.9);
        box-shadow: 2px 2px 6px gray;
        height: 280px;
        /*-webkit-transition: height 0.8s;*/
        /*transition: height 0.8s;*/
    }
    #picker-lighting[data-mode='light_wrgb'] {
        height: 280px;
    }
    #picker-lighting[data-mode='light_wy'] {
        height: 220px;
    }

    .optional-picker {
        display: none;
    }
    #picker-lighting[data-mode='light_wrgb'] #color-picker {
        display: block;
    }
    #picker-lighting[data-mode='light_wy'] #temperature-picker {
        display: block;
    }
    
    #color-picker { overflow: hidden; height: 100px; }
    #color-picker img {
        width: 100%;
        height: 100%;
        border: none;
        padding: 0px;
        margin: 0px;
    }
    #temperature-picker { overflow: hidden; height: 40px; }
    #temperature-picker img {
        width: 100%;
        height: 100%;
        border: none;
        padding: 0px;
        margin: 0px;
    }
    </style>
<script>
$app.onload(function(e) {
    var rid = e.query.rid;
    if (!rid) {
        console.error('empty room id');
        return $mainView.router.loadPage('pages/room-list.html');
    }

    $('#open-room-setting').href += ('?rid=' + rid);

    var room = $db.rooms[rid];
    $('#room-name').innerHTML = room.name;
    $gateway.filter(function(t, m, d) { 
        var dev = $db.devices[m];
        return (dev) && (dev.room === rid);
    });

    // var vw = Math.floor(Math.max(100 / room.w, 100 / room.d));
    var rd = Math.ceil(room.d / 2);
    var rw = Math.ceil(room.w / 2);
    var vw = 'calc((100vw - ' + (35 + rw * 1) + 'px)/' + rw + ')';
    var cell = '<td style="font-size:X;width:X;height:X;"></td>'
    .replace(/X/g, vw);
    var rows = [];
    for (var d = 0; d < rd; ++d) {
        var row = [];
        for (var w = 0; w < rw; ++w) { row.push(cell); }
            rows.push('<tr>' + row.join('') + '</tr>');
    }
    $('#room-grid').innerHTML = rows.join('');
});
$app.onload(function() {
    var base = 0;
    $('#room-grid-outer').addEventListener('touchstart', function(e) {
        if (e.touches.length !== 2) {
            return;
        }
        var p1 = e.touches[0];
        var p2 = e.touches[1];
        var dx = p1.pageX - p2.pageX;
        var dy = p1.pageY - p2.pageY;
        base = Math.pow(dx * dx + dy * dy, 0.5);
    });
    $('#room-grid-outer').addEventListener('touchmove', function(e) {
        if (base === 0) {
            return;
        }

        var p1 = e.touches[0];
        var p2 = e.touches[1];
        var dx = p1.pageX - p2.pageX;
        var dy = p1.pageY - p2.pageY;
        var curr = Math.pow(dx * dx + dy * dy, 0.5);
        console.info(curr / base);
    });
});
$app.onload(function() {
    var editing = false;
    var dnd = [null, null, null];
    $app.touchmove(function(e) {
        var icon = dnd[0];
        if (!icon) { return; }

        var touch = e.touches[0];
        var dx = touch.pageX - dnd[1];
        var dy = touch.pageY - dnd[2];
        icon.style.top = dy + 'px';
        icon.style.left = dx + 'px';
    });
    $app.touchend(function(e) {
        var icon = dnd[0];
        if (!icon) { return; }

        var touch = e.changedTouches[0];
        var x = touch.pageX;
        var y = touch.pageY + $('#room-grid-outer').scrollTop;
        var slot = $('#room-grid td', true).filter(function(i) {
            return !i.innerHTML;
        }).find(function(i) {
            var x1 = i.offsetLeft;
            var x2 = x1 + i.offsetWidth;
            var y1 = i.offsetTop;
            var y2 = y1 + i.offsetHeight;
            return x1 <= x && x <= x2 && y1 <= y && y <= y2;
        });

        if (slot) {
            icon.parentNode.removeChild(icon);
            slot.appendChild(icon);
            var row = slot.parentNode;
            var mac = icon.getAttribute('data-mac');
            var xv = [].indexOf.call(row.childNodes, slot) * 2;
            var yv = [].indexOf.call(row.parentNode.childNodes, row) * 2;
            $db.devices.$update(mac, function(dev) {
                dev.x = xv;
                dev.y = yv;
            }).$save();
        }
        $('#room-grid-outer').style.overflowY = 'auto';
        icon.style.top = icon.style.left = null;
        dnd[0] = null;
    });
    $gateway.watch(function(type, devices) {
        if (editing) { return; }
        var template = '#device-icon-' + type;

        [].forEach.call(Object.keys(devices), function(mac) {
            var icn = $('#m_' + mac);
            var slot = (icn) ? icn.parentNode : null;
            if (!slot) {
                var dev = $db.devices[mac];
                if (dev.x === null || dev.y === null) {
                    slot = $('#room-grid td', true).filter(function(i) {
                        return !i.innerHTML;
                    })[0];
                }
                else {
                    var x = Math.round(dev.x / 2);
                    var y = Math.round(dev.y / 2);
                    slot = $('#room-grid tr', true)[y].childNodes[x];
                }
            }

            slot.innerHTML = $templates(template, devices[mac]);
        });
        $app.onload(function() {
            $('.device-icon[data-new]', true).forEach(function(icon) {
                icon.addEventListener('touchstart', function(e) {
                    if (!editing || e.touches.length !== 1) {
                        return;
                    }

                    dnd[0] = icon;
                    dnd[1] = e.touches[0].pageX;
                    dnd[2] = e.touches[0].pageY;                                
                    $('#room-grid-outer').style.overflowY = 'hidden';
                });

                if (!icon.classList.contains('open-picker')) {
                    return;
                }
                icon.addEventListener('touchstart', function(e) {
                    var type = icon.getAttribute('data-type');
                    var mac = icon.getAttribute('data-mac');
                    var value = icon.getAttribute('data-value');
                    $('#picker-lighting').setAttribute('data-mac', mac);
                    $('#picker-lighting').setAttribute('data-mode', type);
                    $('#picker-lighting').setAttribute('data-value', value);
                    $('#level-slider').value = value.split(',')[0];
                });
                icon.removeAttribute('data-new');
            });
        });
    });
    $app.onload(function() {
        $$('#edit-done-panel').on('picker:close', function() {
            editing = false;
            $('[data-page="room-view"]').removeAttribute('data-editable');                    
        });
        $$('#edit-done-panel').on('picker:open', function() {
            editing = true;
            $('[data-page="room-view"]').setAttribute('data-editable', true);
        });
    });
});
$app.onload(function(e) {
    var rid = e.query.rid;
    var img = $('#color-picker img');
    var canvas = null;
    var ctx = null;
    var mac = null;
    var data = null;
    var waiting = false;
    var format = function(type, mac, wrgb) {
        switch (type) {
            case 'light_wrgb': return { mac: mac, levelW: wrgb[0], levelR: wrgb[1], levelG: wrgb[2], levelB: wrgb[3] };
            case 'light_wy': return { mac: mac, levelW: wrgb[0], levelY: wrgb[4] };
            case 'ac_switch': return { mac: mac, enable: wrgb[0] };
        }
        return null;
    };
    var cap = function(v) {
        return (v > 100) ? 100 :
               (v < 0) ? 0 : v;
    };
    var update = function(w, r, g, b, y) {
        if (waiting) { return; }

        if (!mac) { mac = $('#picker-lighting').getAttribute('data-mac'); }
        if (mac !== $('#picker-lighting').getAttribute('data-mac')) {
            mac = $('#picker-lighting').getAttribute('data-mac');
            data = null;
        }

        if (!data) {
            data = $('#picker-lighting').getAttribute('data-value')
                .split(',').map(function(v) { return v * 1; });
        }
        (w !== null) && (data[0] = cap(w));
        (r !== null) && (data[1] = cap(r));
        (g !== null) && (data[2] = cap(g));
        (b !== null) && (data[3] = cap(b));
        (y !== null) && (data[4] = cap(y));

        waiting = true;
        var type = $('#picker-lighting').getAttribute('data-mode');
        return $gateway.set(mac, format(type, mac, data))
            .then(function() { waiting = false; });
    };

    var apply = function(wrgb, type) {
        var list = $gateway.get(type, function(t, m, d) { 
            return $db.devices[m].room === rid;
        });

        var idx = 0;
        var send = function() {
            if (idx === list.length) { 
                $app.hideIndicator();
                return;
            }

            var dev = list[idx++];
            var payload = format(dev.type, dev.mac, wrgb);
            if (!payload) {
                return setTimeout(send, 0);
            }
            $gateway.set(dev.mac, payload).then(send);
        };
        setTimeout(send, 0);
        $app.showIndicator();
    };
    $('.saved-mode', true).forEach(function(button) {
        button.addEventListener('click', function() {
            var value = button.getAttribute('data-value');
            if (value) {
                return apply(value.split(',').map(function(v) { return v * 1; }))
            }
        });
    });

    var setColor = function(e, t) {
        if (!ctx) {
            canvas = document.createElement('canvas');
            canvas.width = img.offsetWidth;
            canvas.height = img.offsetHeight;
            ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, img.offsetWidth, img.offsetHeight);                    
        }
        var el = e.target;
        var x = t.clientX - el.x;
        var y = t.clientY - el.y;
        var px = canvas.getContext('2d').getImageData(x, y, 1, 1).data;
        update(null, Math.round(px[0] / 2.55), Math.round(px[1] / 2.55), Math.round(px[2] / 2.55), null);
    };
    $('#color-picker').addEventListener('touchmove', function(e) {
        if (e.touches.length !== 1) { return; }
        setColor(e, e.touches[0]);
    });
    $('#color-picker').addEventListener('touchend', function(e) {
        if (e.changedTouches.length !== 1) { return; }
        setColor(e, e.changedTouches[0]);
    });
    $('#temperature-picker').addEventListener('touchmove', function(e) {
        if (e.touches.length !== 1) { return; }
        var touch = e.touches[0];
        var pos = (touch.clientX - touch.target.x);
        var percentage = Math.round(pos * 100 / touch.target.offsetWidth);
        update(null, null, null, null, percentage);
    });
    $('#temperature-picker').addEventListener('touchend', function(e) {
        if (e.changedTouches.length !== 1) { return; }
        var touch = e.changedTouches[0];
        var pos = (touch.clientX - touch.target.x);
        var percentage = Math.round(pos * 100 / touch.target.offsetWidth);
        update(null, null, null, null, percentage);
    });
    $('#level-slider').addEventListener('input', function() {
        update(this.value * 1, null, null, null, null);
    });
    $('#lighting-apply-all').addEventListener('click', function() {
        if (!data) {
            data = $('#picker-lighting').getAttribute('data-value')
                .split(',').map(function(v) { return v * 1; });
        }

        var type = $('#picker-lighting').getAttribute('data-mode');
        apply(data, type);
    });
    $gateway.watch(function(type) {
        $app.onload(function() {
            if (type !== 'ac_switch') {
                return;
            }

            $('.device-icon[data-type="ac_switch"]', true).forEach(function(icon) {
                icon.addEventListener('touchend', function() {
                    if ($('[data-page="room-view"]').hasAttribute('data-editable')) {
                        return;
                    }
                    
                    var val = icon.getAttribute('data-value');
                    var mac = icon.getAttribute('data-mac');
                    $gateway.set(mac, format(type, mac, [(val == 0) ? '1' : '0']));
                });
            });
        });
    });
});
$app.onload(function(e) {
    var rid = e.query.rid;
    $('#add-mode').onclick = function() {
        $app.prompt('', 'mode-name-prompt', function(value) {
            var icons = $(e.container, '.device-icon', true);

            var mode = icons.reduce(function(p, c) {
                var mac = c.getAttribute('data-mac');
                var val = c.getAttribute('data-value');
                p[mac] = val;
                return p;
            }, {});

            var modes = ($db.modes[rid]) || ($db.modes[rid] = []);
            modes.push([value, mode]);
            $db.modes.$save();
        });
    };
});
$app.onload(function(e) {
    var rid = e.query.rid;
    $('#custom-modes').innerHTML = $db.modes[rid].map(function(mode) {
        return $templates('#custom-mode', {name: mode[0]});
    }).join('');
});
$app.onload(function(e) {
    var rid = e.query.rid;
    $('.custom-mode span', true).forEach(function(p) {
        p.onclick = function() {
            $db.modes[rid].forEach(function(mode) {
                if (mode[0] !== p.innerHTML) { return; }
                var values = mode[1];
                var macs = Object.keys(values);
                var idx = 0;
                var send = function() {
                    if (idx === macs.length) { return; }
                    var mac = macs[idx++];
                    $gateway.set(mac, values[mac]).then(send);
                };
                send();
            })
        };
    });
});
</script>

<script id="device-icon-light_wrgb" type="text/template7"><a class='device-icon open-picker' data-type='{{type}}' data-picker='#picker-lighting' data-value='{{levelW}},{{levelR}},{{levelG}},{{levelB}},' data-mac='{{mac}}' id='m_{{mac}}' data-new>
<i class='fa fa-superpowers' aria-hidden="true" style='color:rgb({{levelW}}%,{{levelW}}%,{{levelW}}%)'></i>
<span class='center' style='background:rgb({{levelR}}%,{{levelG}}%,{{levelB}}%)'></span>
</a></script>
<script id="device-icon-light_wy" type="text/template7"><a class='device-icon open-picker' data-type='{{type}}' data-picker='#picker-lighting' data-value='{{levelW}},,,,{{levelY}}' data-mac='{{mac}}' id='m_{{mac}}' data-new>
<i class='fa fa-superpowers' aria-hidden="true" style='color:rgb({{levelW}}%,{{levelW}}%,{{levelW}}%)'></i>
<span class='center' style='background:hsl(58,100%,{{levelY}}%)'></span>
</a></script>
<script id="device-icon-ac_switch" type="text/template7"><a class='device-icon' data-type='{{type}}' data-value='{{enable}}' data-mac='{{mac}}' id='m_{{mac}}' data-new>
<i class="fa fa-power-off" style='color:rgb({{enable}}00%, {{enable}}00%, {{enable}}00%)'></i>
</a></script>
<script id='custom-mode' type='text/template7'><a class='custom-mode saved-mode'><span style='line-height:48px'>{{name}}</span></a></script>

<div class="navbar">
    <div class="navbar-inner">
        <div class="left"><a class='link' id='back-to-list' href='pages/room-list.html'><i class='icon f7-icons'>chevron_left</i></a></div>
        <div class="center" id='room-name'></div>
        <div class="right">
            <a class='link' href='pages/new-room.html' id='open-room-setting'><i class='icon f7-icons'>gear</i></a>
            <a class='link open-picker' data-picker='#edit-done-panel' href='#' id='enable-edit'><i class='icon f7-icons'>keyboard</i></a>
        </div>
    </div>
</div>

<div class='page-content' style='overflow-y: auto'>

    <div id='room-grid-outer'><table id='room-grid'></table></div>
    <a id='show-saved-modes' class='button button-fill open-picker' data-picker='#saved-modes-panel'><i class='icon f7-icons'>filter-fill</i></a>

    <div class='picker-modal' id='picker-lighting'><div class="picker-modal-inner"><div class="content-block">
        <div class='list-block optional-picker' id='color-picker'>
            <img src='img/rgb.png'>
        </div>
        <div class='list-block optional-picker' id='temperature-picker'>
            <img src='img/temperature.png'>
        </div>
        <div class='list-block'>
            <div class="item-input">
                <div class="range-slider">
                    <input id='level-slider' type="range" min="0" max="100" step="1">
                </div>
            </div>
        </div>
        <div class='list-block'>
            <div class='buttons-row'>
            <a href="#" id='lighting-apply-all' class="button button-raised link" data-i18n-key='apply-all'></a>
            <a href="#" id='lighting-done' class="close-picker button button-fill button-raised link" data-i18n-key='done'></a>
            </div>
        </div>
    </div></div></div>

    <div class='picker-modal' id='saved-modes-panel'><div class='picker-modal-inner'><!-- 
     --><span class='saved-mode-group'><!-- 
        --><a id='all-on' class='saved-mode' data-value='100,100,100,100,100'><i class='icon f7-icons'>data_fill</i></a><!-- 
        --><a id='all-off' class='saved-mode' data-value='0,0,0,0,0'><i class='icon f7-icons'>data</i></a>
        </span><!-- 
     --><span class='saved-mode-group' id='custom-modes'><!--
     --></span><!-- 
     --><span class='saved-mode-group'><!--
         --><a id='add-mode' class='saved-mode'><i class='icon f7-icons'>add</i></a><!--         
     --></span><!-- 
 --></div></div>

    <div class="picker-modal" id='edit-done-panel'><div class='picker-modal-inner'><div class='content-block'>
        <a href="#" id='edit-done' class="close-picker button button-fill button-raised link" data-i18n-key='done'></a>
    </div></div></div>
</div>

</div>