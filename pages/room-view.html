<div data-page='room-view' class='page navbar-fixed'>
    <style>
        @keyframes wiggle {
            0% { transform: rotate(0deg); }
            8% { transform: rotate(-10deg); }
            16% { transform: rotate(0deg); }
            24% { transform: rotate(10deg); }
            32% { transform: rotate(0deg); }
            40% { transform: rotate(-10deg); }
            48% { transform: rotate(0deg); }
            56% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }
        .device-icon {
            z-index: 10;
            top: 0px;
            position: absolute;
            display: block;
            width: calc(100% - 10px);
            height: calc(100% - 8px);
            border-radius: 4px;
            margin: 4px;
            box-shadow: 2px 2px 6px gray;
        }
        .device-icon .center {
            width: 50%;
            height: 50%;
            margin: 25%;
            border-radius: 100%;
            display: block;
        }
        #room-grid {
            width: 100%;
            margin: 48px 0px 96px 0px;
            table-layout: fixed;
            border: 3px double black;
            border-collapse: collapse;
            border-spacing: 0px;
        }
        #room-grid td {
            padding: 0px;
            overflow: hidden;
            border: 1px dashed gray;
            white-space: nowrap;
            position: relative;
            overflow: visible;
        }
        .popover {
            width: 100%;
        }
        [data-page="room-view"][data-editable] #room-grid .device-icon {
            animation: wiggle 1s infinite;  
        }
        [data-page="room-view"][data-editable] #room-grid, 
        [data-page="room-view"][data-editable] #room-grid td {
            border-color: #f44336;
            border-style: dotted;
        }
        [data-page="room-view"][data-editable] .device-icon {
            /*box-shadow: 4px 2px 4px #53a8fe;*/
        }

        [data-page="room-view"][data-editable] #edit-done-panel {
            bottom: 0px;
        }
        [data-page="room-view"][data-editable] #enable-edit {
            display: none;
        }

        #edit-done-panel {
            margin:;
            background-color: white;
            z-index: 100;
            position: fixed;
            -webkit-transition: bottom 0.8s; /* Safari */
            transition: bottom 0.8s;
            bottom: -100px;
            width: 100%;
            margin: 0px;
            padding-top: 24px;
            padding-bottom: 24px;
            box-shadow: -2px -2px 4px lightgray;
        }
        #saved-modes {
            position: fixed;
            left: calc(50% - 48px);
            bottom: -48px;
            min-width: 96px;
            height: 96px;
            font-weight: bold;
            margin: 0px auto;
            border-radius: 100px;
            padding: 8px 0px 0px 0px;
            box-shadow: 2px 2px 6px gray;
        }
        #saved-modes > * {
            font-size: 36px;
        }
        #picker-lighting {
            height: 230px;
            box-shadow: 2px 2px 6px gray;            
        }
    </style>
    <script>
        $app.onload(function(e) {
            var rid = e.query.rid;
            if (!rid) {
                console.error('empty room id');
                return $mainView.router.loadPage('/pages/room-list.html');
            }

            var room = $db.rooms[rid];
            $('#room-name').innerHTML = room.name;
            $gateway.filter(function(t, m, d) { 
                return d.room === rid; 
            });

            // var vw = Math.floor(Math.max(100 / room.w, 100 / room.d));
            var vw = 'calc((100vw - ' + (35 + room.w * 1) + 'px)/' + room.w + ')';
            var cell = '<td style="width:X;max-width:X;height:X;max-height:X;"></td>'
                .replace(/X/g, vw);
            var rows = [];
            for (var d = 0; d < room.d; ++d) {
                var row = [];
                for (var w = 0; w < room.w; ++w) { row.push(cell); }
                rows.push('<tr>' + row.join('') + '</tr>');
            }
            $('#room-grid').innerHTML = rows.join('');

        });
        $app.onload(function() {
            var editing = false;
            var timer = null;
            var dnd = [null, null, null];
            $('#edit-done').onclick = function() {
                editing = false;
                $('[data-page="room-view"]').removeAttribute('data-editable');
            };
            $app.touchmove(function(e) {
                var icon = dnd[0];
                if (!icon) { return; }

                var touch = e.touches[0];
                var dx = touch.pageX - dnd[1];
                var dy = touch.pageY - dnd[2];
                icon.style.top = dy + 'px';
                icon.style.left = dx + 'px';
            });
            $app.touchend(function(e) { if (timer) { clearTimeout(timer); } });
            $app.touchend(function(e) {
                var icon = dnd[0];
                if (!icon) { return; }

                var touch = e.changedTouches[0];
                var x = touch.pageX;
                var y = touch.pageY + $('.page-content').scrollTop;
                var slot = $('#room-grid td', true).filter(function(i) {
                    return !i.innerHTML;
                }).find(function(i) {
                    var x1 = i.offsetLeft;
                    var x2 = x1 + i.offsetWidth;
                    var y1 = i.offsetTop;
                    var y2 = y1 + i.offsetHeight;
                    return x1 <= x && x <= x2 && y1 <= y && y <= y2;
                });

                if (slot) {
                    icon.parentNode.removeChild(icon);
                    slot.appendChild(icon);
                    var row = slot.parentNode;
                    var mac = icon.getAttribute('data-mac');
                    var xv = [].indexOf.call(row.childNodes, slot) * 2;
                    var yv = [].indexOf.call(row.parentNode.childNodes, row) * 2;
                    $gateway.set('x', xv, [mac]);
                    $gateway.set('y', yv, [mac]);
                }
                $('.page-content').style.overflowY = 'auto';
                icon.style.top = icon.style.left = null;
                dnd[0] = null;
            });
            $gateway.watch(function(type, devices) {
                if (editing) { return; }
                var template = '#device-icon-' + type;

                [].forEach.call(Object.keys(devices), function(mac) {
                    var dev = devices[mac];
                    var icn = $('#m_' + mac);
                    if (icn) {
                        icn.parentNode.innerHTML = $templates(template, dev);
                    }
                    else if (dev.x === undefined || dev.y === undefined) {
                        var slot = $('#room-grid td', true).filter(function(i) {
                            return !i.innerHTML;
                        })[0];
                        var row = slot.parentNode;
                        var x = dev.x = [].indexOf.call(row.childNodes, slot) * 2;
                        var y = dev.y = [].indexOf.call(row.parentNode.childNodes, row) * 2;
                        slot.innerHTML = $templates(template, dev);
                    }
                    else {
                        var x = Math.round(dev.x / 2);
                        var y = Math.round(dev.y / 2);
                        var slot = $('#room-grid tr', true)[y].childNodes[x];
                        slot.innerHTML = $templates(template, dev);
                    }
                });
                $app.onload(function() {
                    $('.device-icon[data-new]', true).forEach(function(icon) {
                        icon.addEventListener('touchstart', function(e) {
                            if (!editing) {
                                return;
                            }

                            dnd[0] = icon;
                            dnd[1] = e.touches[0].pageX;
                            dnd[2] = e.touches[0].pageY;                                
                            $('.page-content').style.overflowY = 'hidden';
                        });
                        icon.removeAttribute('data-new');
                    });
                });
                $app.onload(function() {
                    $('#enable-edit').onclick = function() {
                        $('[data-page="room-view"]').setAttribute('data-editable', true);
                        editing = true;
                    };
                });
            });
        });
        $app.onload(function() {
        });
    </script>

    <!-- var types = ['light_wrgb', 'lighting', 'ac_switch']; -->
    <script id="device-icon-light_wrgb" type="text/template7"><a class='device-icon open-picker' data-picker='#picker-lighting' data-mac='{{mac}}' id='m_{{mac}}' data-new style='background:rgb({{levelW}}%,{{levelW}}%,{{levelW}}%)'><span class='center' style='background:rgb({{levelR}}%,{{levelG}}%,{{levelB}}%)'></span></a></script>
    <script id="device-icon-lighting" type="text/template7"><a class='device-icon open-picker' data-picker='#picker-lighting' data-mac='{{mac}}' id='m_{{mac}}' data-new style='background:rgb({{level}}%,{{level}}%,{{level}}%)'></a></script>

    <div class="navbar">
        <div class="navbar-inner">
            <div class="left"><a class='link' href='#' id='go-to-list'><i class='icon f7-icons'>chevron_left</i></a></div>
            <div class="center" id='room-name'></div>
            <div class="right"><a class='link' href='#' id='enable-edit'><i class='icon f7-icons'>more_vertical</i></a></div>
        </div>
    </div>


    <div class='page-content' style='overflow-y: auto'>

        <div class='picker-modal' id='picker-lighting'>
            <div class="picker-modal-inner">
                <div class="content-block">
<div class='list-block'>
<div class="item-input">
<div class="range-slider">
<input type="range" min="0" max="100" step="1">
</div>
</div>
</div>

<div class='list-block'>
<a href="#" id='apply-all' class="button button-raised link" data-i18n-key='apply-all'></a>
</div>
<div class='list-block'>
<a href="#" id='apply-all' class="close-picker button button-fill button-raised link" data-i18n-key='done'></a>
</div>

                </div>
            </div>
        </div>

        <div class='content-block'>
            <table id='room-grid'></table>
            <a id='saved-modes' class='button button-fill raised'><i class='icon f7-icons'>filter-fill</i></a>
        </div>
        <div class="content-block" id='edit-done-panel'>
            <a href="#" id='edit-done' class="button button-fill button-raised link" data-i18n-key='done'></a>
        </div>
    </div>
</div>