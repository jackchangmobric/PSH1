<div data-page='room-view' class='page navbar-fixed'>
<style>
    @keyframes wiggle {
        0% { transform: rotate(0deg); }
        8% { transform: rotate(-10deg); }
        16% { transform: rotate(0deg); }
        24% { transform: rotate(10deg); }
        32% { transform: rotate(0deg); }
        40% { transform: rotate(-10deg); }
        48% { transform: rotate(0deg); }
        56% { transform: rotate(10deg); }
        100% { transform: rotate(0deg); }
    }
    [data-page='room-view'] .device-icon {
        z-index: 10;
        top: 0px;
        position: absolute;
        display: block;
        width: calc(100% - 16px);
        height: calc(100% - 16px);
        border-radius: 100px;
        margin: 8px;
        background-repeat: no-repeat;
        background-size: 100%;
        background-position: center;
        box-shadow: 0px 0px 4px 4px rgba(91, 142, 236, 0.2);

        /*box-shadow: 2px 2px 6px gray;*/
        /*background: none !important;*/
    }
    [data-page='room-view'] .device-icon .center {
        width: 36%;
        height: 36%;
        margin: 32%;
        border-radius: 100%;
        display: inline-block;
        position: absolute;
        border: thin solid lightgrey;
        top: 0px;
        /*box-shadow: 2px 2px 8px gray;*/
    }
    [data-page='room-view'] .device-icon i.fa {
        position:absolute;
        top:50%;
        width:100%;
        transform:translate(0,-50%);
        text-align:center;
        font-size: 70%;
        text-shadow: 2px 2px 8px gray;
    }
    [data-page='room-view'] #room-grid-outer {
        position:absolute;
        top:0px;
        bottom:0px;
        left:0px;
        right:0px;
        overflow-y:auto;
        /*padding-top: 32px;*/
        padding: 65px 15px 15px 15px;
    }
    [data-page='room-view'] #room-grid {
        width: 100%;
        margin: 0px 0px 96px 0px;
        table-layout: fixed;
        border: 3px solid transparent;
        border-collapse: collapse;
        border-spacing: 0px;
        transform-origin: top left;
        box-shadow: 0px 0px 4px 4px rgba(91, 142, 236, 0.2);
    }
    [data-page='room-view'] #room-grid td {
        padding: 0px;
        overflow: hidden;
        border: thin dashed transparent;
        white-space: nowrap;
        position: relative;
        overflow: visible;
    }
    [data-page="room-view"][data-editable] #room-grid .device-icon {
        animation: wiggle 1s infinite;  
    }
    [data-page="room-view"][data-editable] #room-grid, 
    [data-page="room-view"][data-editable] #room-grid td {
        border-color: rgb(91, 142, 236);
        border-style: dotted;
    }
    [data-page="room-view"][data-editable] .device-icon {
        /*box-shadow: 4px 2px 4px #53a8fe;*/
    }

    [data-page="room-view"][data-editable] #show-saved-modes,
    [data-page="room-view"][data-editable] .navbar .link {
        display: none;
    }

    [data-page='room-view'] #show-saved-modes {
        z-index: 90;
        background-color: rgb(91, 142, 236);
        position: absolute;
        left: calc(50% - 48px);
        bottom: 0px;
        min-width: 96px;
        height: 48px;
        font-weight: bold;
        margin: 0px auto;
        border-radius: 96px 96px 0px 0px !important;
        padding: 8px 0px 0px 0px;
        /*border: 6px solid rgb(139,173,241) !important;*/
        box-shadow: 0px 0px 6px 6px rgba(91, 142, 236, 0.5);
    }
    [data-page='room-view'] #show-saved-modes > * {
        font-size: 36px;
    }

    #edit-done-panel {
        background-color: transparent;
        height: 113px;
        opacity: 0.8;
    }
    #edit-done-panel .content-block {
        padding: 0px 60px;
    }
    #saved-modes-panel {
        background-color: rgba(50,50,50,0.8);
        height: 100%;
    }
    #saved-modes-panel > .picker-modal-inner {
        background-color: white;
        line-height: 1em;
        height: auto;
        /*background-color: white;*/
        position: absolute;
        /*width: 100%;*/
        bottom: 15px;
        left: 15px;
        right: 15px;
        border-radius: 12px;
    }
    #saved-modes-panel #close-saved-modes-panel {
        display: block;
        text-align: center;
        font-weight: bold;
    }
    #saved-modes-panel .saved-mode-group {
        /*border-bottom: 1px solid dimgray;*/
        display: block;
        padding: 32px 0px;
        vertical-align: top;
        margin: 15px 15px;
        background: #F8F8F8;
        border-radius: 12px;
        box-shadow: 0px 0px 4px 4px rgba(91, 142, 236, 0.2);
    }
    #saved-modes-panel .saved-mode-group:empty {
        display: none;
    }
    #saved-modes-panel .saved-mode-group:last-child {
        border: none;
    }
    #saved-modes-panel .saved-mode {
        /*background: dimgray;*/
        display: block;
        border-radius: 8px;
        height: 54px;
        /*width: 48px;*/
        /*padding: 0px 24px;*/
        /*box-shadow: 2px 2px 6px gray;*/
        font-size: 18px;
        margin: -8px 16px;
        text-align: left;
        color: darkgray;
        vertical-align: middle;
    }
    #saved-modes-panel .saved-mode > span {
        line-height: 24px;
        margin: 15px 15px;
        display: inline-block;    
        font-size: 20px;   
    }
    #saved-modes-panel .saved-mode > * {
        vertical-align: middle;
    }
    #saved-modes-panel .saved-mode[data-empty] {
        color: lightgray;
    }
    #saved-modes-panel .saved-mode-group a.saved-mode:nth-child(even) {
        text-align: left;
    }
    #saved-modes-panel .saved-mode-group a.saved-mode:nth-child(even) i {
        float: left;
    }
    #saved-modes-panel .saved-mode-group a.saved-mode:nth-child(odd) {
        text-align: right;
    }
    #saved-modes-panel .saved-mode-group a.saved-mode:nth-child(odd) i {
        float: right;
    }
    #saved-modes-panel .saved-mode-group a i {
        /*color: lightblue;*/
        line-height: 54px;
        border-radius: 48px;
        /* border: 1px solid lightgray; */
        width: 54px;
        height: 54px;
        color: white;
        background-color: #BBB;
        text-align: center;
        font-size: 30px;
    }
    #saved-modes-panel .saved-mode-group#custom-modes .saved-mode[data-remove] .remove {
        display: block;
        background-color: white;
        color: red;
        box-shadow: 0px 0px 6px 6px rgba(91, 142, 236, 0.4);
    }
    #saved-modes-panel .saved-mode-group#custom-modes .saved-mode[data-remove] i {
        display: none;
    }
    #saved-modes-panel .saved-mode-group#custom-modes .saved-mode[data-remove] span {
        border-color: transparent;
    }
    #saved-modes-panel .saved-mode-group#custom-modes .saved-mode i {
        background: rgb(91,142,236);
        color: white;
        background-repeat: no-repeat;
        background-position: center;
        background-size: 40px
    }
    #saved-modes-panel .saved-mode-group#custom-modes .saved-mode .remove {
        display: none;
    }
    #saved-modes-panel .saved-mode-group#custom-modes a:nth-child(even) span {
        padding-left: 20px;
    }
    #saved-modes-panel .saved-mode-group#custom-modes a:nth-child(odd) span {
        padding-right: 20px;
    }
    #saved-modes-panel .saved-mode-group#custom-modes a span {
        color: rgb(91,142,236);
        border-bottom: 4px solid rgb(91,142,236);
        margin-left: -5px;
        margin-right: -5px;
    }
    #add-new-mode {
        background-color: transparent !important;
        color: rgb(91,142,236) !important;
        box-shadow: 0px 0px 6px 6px rgba(91, 142, 236, 0.4) !important;
    }
    #all-on i {
        color: white;
        background: rgb(91,142,236) !important;
    }
    #all-on span {
        color: rgb(91,142,236) !important;
        border-bottom: 4px solid rgb(91,142,236);
        margin-left: -5px !important;
        margin-right: -5px !important;
        z-index: -1;
        padding-right: 20px;
    }
    #all-off i {
        color: white;
    }
    #all-off span {
        color: #BBB !important;
        border-bottom: 4px solid #BBB;
        margin-left: -5px !important;
        margin-right: -5px !important;
        padding-left: 20px;
        z-index: -1;
    }

    #picker-lighting {
        height: 100%;
        background-color: rgba(50,50,50,0.8);
        /*-webkit-transition: height 0.8s;*/
        /*transition: height 0.8s;*/
    }
    #picker-lighting input[type=range] {
        border-radius: 16px;
        background: rgb(194,217,248);        
    }
    #picker-lighting .picker-modal-inner {
        background-color: rgb(220,234,252);
        margin: 0px 15px;
        height: auto;
        border-radius: 12px;
        top: 50%;
        position: absolute;
        transform: translateY(-50%);
    }
    #picker-lighting .item-label {
        color: #BBB;
        padding: 8px;
    }
    #picker-lighting .list-block {
        /*margin-top: 30px;*/
    }
    #picker-lighting #lighting-apply-all,
    #picker-lighting #lighting-toggle,
    #picker-lighting #lighting-done {
        padding-top: 64px;
        border-radius: 0px !important;
        background-repeat: no-repeat;
        background-position: top center;
        background-size: 54px;
        background-color: transparent;
        box-shadow: none;        
    }
    #picker-lighting .predefined-colors span {
        display: inline-block;
        border-radius: 4px;
        width: 22px;
        height: 22px;
        margin: 16px 2px 8px 2px;
    }
    #picker-lighting #lighting-apply-all {
        color: #AAA;
        margin-left: 15px;
        position: absolute;
        width: 100px;
        left: 0px;
        background-image: url(img/icons/001.png);  
        z-index: 1000;      
    }
    #picker-lighting #lighting-toggle {
        background-image: url(img/icons/007.png);
        background-size: 72px;
    }
    #picker-lighting #lighting-toggle[data-can-off] {
        background-image: url(img/icons/006.png);
    }
    #picker-lighting #lighting-done {
        margin-right: 15px;
        position: absolute;
        width: 100px;
        right: 0px;
        background-image: url(img/icons/003.png);
        z-index: 1000;      
    }

    #picker-lighting .optional-picker {
        display: none;
    }
    #picker-lighting[data-mode='light_wrgb'] #color-picker {
        display: block;
    }
    #picker-lighting[data-mode='light_wy'] #temperature-picker {
        display: block;
    }
    
    #picker-lighting #color-picker { 
        overflow: hidden; 
        text-align: center;
    }
    #picker-lighting #color-picker img {
        width: 70%;
        border: none;
        padding: 0px;
        margin: 0px;
    }
    #picker-lighting #color-picker #current-color {
        position: absolute;
        width: 80px;
        height: 80px;
        top: 120px;
        left: calc(50% - 40px);
        color: black;
        border-radius: 100px;
        line-height: 80px;
        font-size: 14px;        
    }
    #picker-lighting #temperature-picker {
        overflow: hidden;
        text-align: center;
    }
    #picker-lighting #temperature-picker img {
        width: 70%;
        border: none;
        padding: 0px;
        margin: 0px;
    }
    #picker-lighting #temperature-picker #current-temperature {
        position: absolute;
        width: 80px;
        height: 80px;
        top: 120px;
        left: calc(50% - 40px);
        color: black;
        border-radius: 100px;
        line-height: 80px;
        font-size: 14px;        
    }
    #picker-lighting .buttons-row {
        padding-top: 22px;
    }
    </style>
<script>

var roomViewFormat = function(type, mac, wrgb, dev) {
    console.info(arguments);
    switch (type) {
        case 'light_wrgb': return { mac: mac, 
            levelW: (wrgb[0] === '' && dev) ? dev.levelW : wrgb[0], 
            levelR: (wrgb[1] === '' && dev) ? dev.levelR : wrgb[1], 
            levelG: (wrgb[2] === '' && dev) ? dev.levelG : wrgb[2], 
            levelB: (wrgb[3] === '' && dev) ? dev.levelB : wrgb[3] 
        };
        case 'light_wy': return { mac: mac, 
            levelW: (wrgb[0] === '' && dev) ? dev.levelW : wrgb[0], 
            levelY: (wrgb[4] === '' && dev) ? dev.levelY : wrgb[4] 
        };
        case 'ac_switch': return { mac: mac, 
            enable: (wrgb[0] == 0) ? '0' : '1' 
        };
    }
    return null;
};
var roomViewToValue = function(type, dev) {
    switch (type) {
        case 'light_wrgb': return [dev.levelW,dev.levelR,dev.levelG,dev.levelB,].join(',');
        case 'light_wy': return [dev.levelW,,,,dev.levelY].join(',');
        case 'ac_switch': return [dev.enable];
    }
    return null;
};

$page.onload(function(e) {
    $('.predefined-colors span', true).forEach(function(el) {
        el.style.backgroundColor = 'rgb(' + el.getAttribute('data-color') + ')';
    });
});

$page.onload(function(e) {
    var rid = e.query.rid;
    if (!rid) {
        console.error('empty room id');
        return $mainView.router.loadPage('pages/room-list.html');
    }

    $('#open-room-setting').href += ('?rid=' + rid);

    var room = $db.rooms[rid];
    $('#room-name').innerHTML = room.name;
    $gateway.filter(function(t, m, d) { 
        var dev = $db.devices[m];
        return (dev) && (dev.room === rid);
    });

    // var vw = Math.floor(Math.max(100 / room.w, 100 / room.d));
    var rd = Math.ceil(room.d / 2);
    var rw = Math.ceil(room.w / 2);
    var vw = 'calc((100vw - ' + (35 + rw * 1) + 'px)/' + rw + ')';
    var cell = '<td style="font-size:X;width:X;height:X;"></td>'
    .replace(/X/g, vw);
    var rows = [];
    for (var d = 0; d < rd; ++d) {
        var row = [];
        for (var w = 0; w < rw; ++w) { row.push(cell); }
            rows.push('<tr>' + row.join('') + '</tr>');
    }
    $('#room-grid').innerHTML = rows.join('');
});
$page.onload(function(e) {
    var rid = e.query.rid;
    $gateway.updated(function() {
        $('.device-icon', true).forEach(function(icon) {
            var mac = icon.getAttribute('data-mac');
            if ($db.devices[mac].room !== rid) {
                icon.parentNode.removeChild(icon);
            }
        });
    });
});
$page.onload(function() {
    var editing = false;
    var dnd = [null, null, null];
    $app.touchmove(function(e) {
        var icon = dnd[0];
        if (!icon) { return; }

        var touch = e.touches[0];
        var dx = touch.pageX - dnd[1];
        var dy = touch.pageY - dnd[2];
        icon.style.top = dy + 'px';
        icon.style.left = dx + 'px';
    });
    $app.touchend(function(e) {
        var icon = dnd[0];
        if (!icon) { return; }

        var touch = e.changedTouches[0];
        var x = touch.pageX;
        var y = touch.pageY + $('#room-grid-outer').scrollTop;
        var slot = $('#room-grid td', true).filter(function(i) {
            return !i.innerHTML;
        }).find(function(i) {
            var x1 = i.offsetLeft;
            var x2 = x1 + i.offsetWidth;
            var y1 = i.offsetTop;
            var y2 = y1 + i.offsetHeight;
            return x1 <= x && x <= x2 && y1 <= y && y <= y2;
        });

        if (slot) {
            icon.parentNode.removeChild(icon);
            slot.appendChild(icon);
            var row = slot.parentNode;
            var mac = icon.getAttribute('data-mac');
            var xv = [].indexOf.call(row.childNodes, slot) * 2;
            var yv = [].indexOf.call(row.parentNode.childNodes, row) * 2;
            $db.devices.$update(mac, function(dev) {
                dev.x = xv;
                dev.y = yv;
            }).$save();
        }
        $('#room-grid-outer').style.overflowY = 'auto';
        icon.style.top = icon.style.left = null;
        dnd[0] = null;
    });
    $gateway.watch(function(type, devices) {
        if (editing) { return; }
        var template = '#device-icon-' + type;
        var image = $('#image-' + type);
        var pixels = (function() {
            var canvas = document.createElement('canvas');
            canvas.width = image.offsetWidth;
            canvas.height = image.offsetHeight;
            ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0, image.offsetWidth, image.offsetHeight);                    
            var tmp = ctx.getImageData(0, 0, image.offsetWidth, image.offsetHeight);
            for (var i = 0; i < tmp.data.length; i += 4) {
                if (tmp.data[i] !== 255) { continue; }
                if (tmp.data[i + 1] !== 255) { continue; }
                if (tmp.data[i + 2] !== 255) { continue; }
                tmp.data[i + 3] = 0;
            }
            return tmp;
        })();

        [].forEach.call(Object.keys(devices), function(mac) {
            var icn = $('#m_' + mac);
            var slot = (icn) ? icn.parentNode : null;
            if (!slot) {
                var dev = $db.devices[mac];
                if (dev.x === null || dev.y === null) {
                    slot = $('#room-grid td', true).filter(function(i) {
                        return !i.innerHTML;
                    })[0];
                }
                else {
                    var x = Math.round(dev.x / 2);
                    var y = Math.round(dev.y / 2);
                    slot = $('#room-grid tr', true)[y].childNodes[x];
                }
            }
            if (!icn) {
                slot.innerHTML = $templates(template, devices[mac]);                
            }
            else {
                icn.setAttribute('data-value', roomViewToValue(type, devices[mac]));
            }
        });
        $page.onload(function() {
            [].forEach.call(Object.keys(devices), function(mac) {
                var icn = $('#m_' + mac);
                var dev = devices[mac];
                var rgb = [0,0,0,255];

                if (type === 'ac_switch') {
                    if (dev.enable == 1) { rgb[0]= 91;rgb[1]=142;rgb[2]=236; }
                    else                 { rgb[0]=180;rgb[1]=180;rgb[2]=180; }
                }
                else if (type === 'light_wrgb') {
                    rgb[0] = Math.round(dev.levelR * 2.55);
                    rgb[1] = Math.round(dev.levelG * 2.55);
                    rgb[2] = Math.round(dev.levelB * 2.55);
                    rgb[3] = 55 + dev.levelW * 2;
                }
                else if (type === 'light_wy') {
                    rgb[0] = 253;
                    rgb[1] = 232;
                    rgb[2] = 46;
                    rgb[3] = 55 + dev.levelW * 2;
                }
                for (var i = 0; i < pixels.data.length; i += 4) {
                    if (pixels.data[i + 3] === 0) { continue; }
                    pixels.data[i] = rgb[0];
                    pixels.data[i + 1] = rgb[1];
                    pixels.data[i + 2] = rgb[2];
                    pixels.data[i + 3] = rgb[3];
                }
                $(icn, 'canvas').width = image.offsetWidth;
                $(icn, 'canvas').height = image.offsetHeight;
                $(icn, 'canvas').getContext('2d').putImageData(pixels, 0, 0);
            });
        });
        $page.onload(function() {
            $('.device-icon[data-new]', true).forEach(function(icon) {
                var timer = null;
                var type = icon.getAttribute('data-type');
                var mac = icon.getAttribute('data-mac');


                if (type === 'ac_switch') {
                    icon.addEventListener('touchend', function() {
                        if ($('[data-page="room-view"]').hasAttribute('data-editable')) {
                            return;
                        }
                        
                        var val = icon.getAttribute('data-value');
                        var mac = icon.getAttribute('data-mac');
                        // console.info([mac,val]);
                        $gateway.set(mac, roomViewFormat(type, mac, [(val == 0) ? '1' : '0']))
                            .then(function() {

                            })
                            .catch(function(e) {
                                $app.alert('', e);
                            });
                    });
                }
                // if (type === 'ac_switch') { return; }
                icon.addEventListener('touchstart', function(e) {
                    if (!editing)  {
                        timer = setTimeout(function() {
                            var values = [
                                [100,100,100,100,100],
                                [0,0,0,0,0]
                            ];
                            var tidx = 0;
                            var test = setInterval(function() {
                                var payload = roomViewFormat(type, mac, (tidx) ? values[0] : values[1]);
                                $gateway.set(mac, payload).then(function() {
                                }).catch(function(e) {
                                    $app.alert('', e);
                                });
                                tidx ^= 1;
                            }, 1500);
                            $app.modal({
                                title: $('.strings #remove-device-confirm-title').innerHTML,
                                text: $('.strings #remove-device-confirm').innerHTML,
                                buttons: [
                                    {
                                        text: $('.strings #remove-confirm').innerHTML,
                                        onClick: function() {
                                            $db.devices.$update(function(tbl) {
                                                delete tbl[mac].room;
                                            }).$save().then(function() {
                                                clearInterval(test);
                                            });
                                        }
                                    },
                                    {
                                        text: $('.strings #remove-cancel').innerHTML,
                                        onClick: function() { 
                                            clearInterval(test);
                                        }
                                    }
                                ]
                            });
                            clearTimeout(timer);
                            timer = null;
                        }, 1500);
                    }
                    else {
                        dnd[0] = icon;
                        dnd[1] = e.touches[0].pageX;
                        dnd[2] = e.touches[0].pageY;                                
                        $('#room-grid-outer').style.overflowY = 'hidden';
                    }
                });

                icon.addEventListener('touchend', function(e) {
                    if (!timer) {
                        return;
                    }

                    clearTimeout(timer);
                    timer = null;
                    if (!icon.classList.contains('open-picker')) {                        
                        return;
                    }

                    var value = icon.getAttribute('data-value');
                    var wrgb = value.split(',').map(function(v) { return v * 1; });

                    $('#picker-lighting').setAttribute('data-mac', mac);
                    $('#picker-lighting').setAttribute('data-mode', type);
                    $('#picker-lighting').setAttribute('data-value', value);
                    setTimeout(function() {
                        var img2 = $('#temperature-picker img');
                        var canvas2 = document.createElement('canvas');
                        canvas2.width = img2.offsetWidth;
                        canvas2.height = img2.offsetHeight;
                        var ctx2 = canvas2.getContext('2d');
                        ctx2.drawImage(img2, 0, 0, img2.offsetWidth, img2.offsetHeight);                    
                        var yvalue = wrgb[4];
                        var arc = (yvalue > 50) ? (-Math.PI + Math.PI * (yvalue - 50)/50) : (Math.PI * (yvalue/50));
                        var x = (img2.offsetWidth / 2) + Math.cos(arc) * (img2.offsetWidth / 2.5);
                        var y = (img2.offsetHeight / 2) - Math.sin(arc) * (img2.offsetHeight / 2.5);
                        var pxl = ctx2.getImageData(x, y, 1, 1).data;
                        $('#level-slider').value = wrgb[0];
                        if (wrgb[0]) {
                            $('#lighting-toggle').setAttribute('data-can-off', true);
                        }
                        else {
                            $('#lighting-toggle').removeAttribute('data-can-off');
                        }
                        $('#current-color').style.backgroundColor = 'rgb(' + 
                            Math.round(wrgb[1] * 2.55) + ',' + 
                            Math.round(wrgb[2] * 2.55) + ',' + 
                            Math.round(wrgb[3] * 2.55) + ')';
                        $('#current-temperature').style.backgroundColor = 'rgb(' + 
                            Math.round(pxl[0]) + ',' + 
                            Math.round(pxl[1]) + ',' + 
                            Math.round(pxl[2]) + ')';
                        $('#current-temperature').innerHTML = (2700 + 23 * yvalue) + 'K';
                    }, 0);
                });
                icon.removeAttribute('data-new');
            });
        });
    });
    $page.onload(function() {
        $$('#edit-done-panel').on('picker:close', function() {
            editing = false;
            $('[data-page="room-view"]').removeAttribute('data-editable');                    
        });
        $$('#edit-done-panel').on('picker:open', function() {
            editing = true;
            $('[data-page="room-view"]').setAttribute('data-editable', true);
        });
    });
});
$page.onload(function(e) {
    var rid = e.query.rid;
    var img = $('#color-picker img');
    var img2 = $('#temperature-picker img');
    var canvas = null;
    var ctx = null;
    var canvas2 = null;
    var ctx2 = null;
    var mac = null;
    var data = null;
    var waiting = false;
    var cap = function(v) {
        return (v > 100) ? 100 :
               (v < 0) ? 0 : v;
    };
    var update = function(w, r, g, b, y) {
        if (waiting) { return; }

        if (!mac) { mac = $('#picker-lighting').getAttribute('data-mac'); }
        if (mac !== $('#picker-lighting').getAttribute('data-mac')) {
            mac = $('#picker-lighting').getAttribute('data-mac');
            data = null;
        }

        if (!data) {
            data = $('#picker-lighting').getAttribute('data-value')
                .split(',').map(function(v) { return v * 1; });
        }
        (w !== null) && (data[0] = cap(w));
        (r !== null) && (data[1] = cap(r));
        (g !== null) && (data[2] = cap(g));
        (b !== null) && (data[3] = cap(b));
        (y !== null) && (data[4] = cap(y));

        waiting = true;
        var type = $('#picker-lighting').getAttribute('data-mode');
        return $gateway.set(mac, roomViewFormat(type, mac, data))
            .then(function() { waiting = false; })
            .catch(function(e) {
                $app.alert('', e);
                waiting = false;
            });
    };

    var apply = function(wrgb, type) {
        var list = $gateway.get(type, function(t, m, d) { 
            return $db.devices[m].room === rid;
        });

        var idx = 0;
        var send = function() {
            if (idx === list.length) { 
                $app.hideIndicator();
                return;
            }

            var dev = list[idx++];
            var payload = roomViewFormat(dev.type, dev.mac, wrgb, dev);
            if (!payload) {
                return setTimeout(send, 0);
            }
            $gateway.set(dev.mac, payload).then(send)
            .catch(function(e) {
                $app.alert('', e);
                send();
            });
        };
        setTimeout(send, 0);
        $app.showIndicator();
    };
    $('#saved-modes-panel .saved-mode', true).forEach(function(button) {
        button.addEventListener('click', function() {
            var value = button.getAttribute('data-value');
            if (value) {
                return apply(value.split(',').map(function(v) { return v; }));
            }
        });
    });

    $('.predefined-colors span', true).forEach(function(el) {
        el.onclick = function() {
            setColor(el.getAttribute('data-color').split(',').map(function(v) { return v * 1; }));
        };
    });


    var setColor = function(rgb) {
        update(null, Math.round(rgb[0] / 2.55), Math.round(rgb[1] / 2.55), Math.round(rgb[2] / 2.55), null);
        $('#current-color').style.backgroundColor = 'rgb(' + 
            rgb[0] + ',' + 
            rgb[1] + ',' + 
            rgb[2] + ')';
    };
    var getColor = function(e, t) {
        if (!ctx) {
            canvas = document.createElement('canvas');
            canvas.width = img.offsetWidth;
            canvas.height = img.offsetHeight;
            ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, img.offsetWidth, img.offsetHeight);                    
        }
        var el = e.target;
        var x = t.clientX - el.x;
        var y = t.clientY - (el.y - $('#picker-lighting .picker-modal-inner').offsetHeight / 2);
        var px = canvas.getContext('2d').getImageData(x, y, 1, 1).data;
        return [px[0], px[1], px[2]];
    };
    $('#color-picker img').addEventListener('touchmove', function(e) {
        if (e.touches.length !== 1) { return; }
        setColor(getColor(e, e.touches[0]));
    });
    $('#color-picker img').addEventListener('touchend', function(e) {
        if (e.changedTouches.length !== 1) { return; }
        setColor(getColor(e, e.changedTouches[0]));
    });
    $('#temperature-picker').addEventListener('touchmove', function(e) {
        if (e.touches.length !== 1) { return; }
        
        if (!ctx2) {
            canvas2 = document.createElement('canvas');
            canvas2.width = img2.offsetWidth;
            canvas2.height = img2.offsetHeight;
            ctx2 = canvas2.getContext('2d');
            ctx2.drawImage(img2, 0, 0, img2.offsetWidth, img2.offsetHeight);                    
        }

        var t = e.touches[0];
        var el = e.target;
        var x = t.clientX - el.x;
        var y = t.clientY - (el.y - $('#picker-lighting .picker-modal-inner').offsetHeight / 2);
        var dx = x - el.offsetWidth / 2;
        var dy = y - el.offsetHeight / 2;
        var arc = Math.atan2(dy, dx);
        if (arc < 0) { arc = -arc; }
        else { arc = Math.PI * 2 - arc; }
        var arc2 = Math.round(arc / (Math.PI * 2) * 100);

        var px = ctx2.getImageData(x, y, 1, 1).data;
        $('#current-temperature').style.backgroundColor = 'rgb(' + 
            [px[0],px[1],px[2]] + 
        ')';
        $('#current-temperature').innerHTML = (2700 + 23 * arc2) + 'K';
        update(null, null, null, null, arc2);
    });
    $('#temperature-picker').addEventListener('touchend', function(e) {
        if (e.changedTouches.length !== 1) { return; }

        if (!ctx2) {
            canvas2 = document.createElement('canvas');
            canvas2.width = img2.offsetWidth;
            canvas2.height = img2.offsetHeight;
            ctx2 = canvas2.getContext('2d');
            ctx2.drawImage(img2, 0, 0, img2.offsetWidth, img2.offsetHeight);                    
        }

        var t = e.changedTouches[0];
        var el = e.target;
        var x = t.clientX - el.x;
        var y = t.clientY - (el.y - $('#picker-lighting .picker-modal-inner').offsetHeight / 2);
        var dx = x - el.offsetWidth / 2;
        var dy = y - el.offsetHeight / 2;
        var arc = Math.atan2(dy, dx);
        if (arc < 0) { arc = -arc; }
        else { arc = Math.PI * 2 - arc; }
        var arc2 = Math.round(arc / (Math.PI * 2) * 100);

        var px = ctx2.getImageData(x, y, 1, 1).data;
        $('#current-temperature').style.backgroundColor = 'rgb(' + 
            [px[0],px[1],px[2]] + 
        ')';
        $('#current-temperature').innerHTML = (2700 + 23 * arc2) + 'K';
        update(null, null, null, null, arc2);
    });
    $('#level-slider').addEventListener('input', function() {
        update(this.value * 1, null, null, null, null);
        if (this.value * 1) {
            $('#lighting-toggle').setAttribute('data-can-off', true);
        }
        else {
            $('#lighting-toggle').removeAttribute('data-can-off', true);
        }
    });
    $('#lighting-toggle').addEventListener('click', function() {
        var w = $('#level-slider').value * 1;
        if (w === 0) {
            $('#level-slider').value = 100;
            update(100, null, null, null, null);
            $('#lighting-toggle').setAttribute('data-can-off', true);
        }
        else {
            $('#level-slider').value = 0;
            update(0, null, null, null, null);
            $('#lighting-toggle').removeAttribute('data-can-off');
        }
    });
    $('#lighting-apply-all').addEventListener('click', function() {
        if (!data) {
            data = $('#picker-lighting').getAttribute('data-value')
                .split(',').map(function(v) { return v * 1; });
        }

        var type = $('#picker-lighting').getAttribute('data-mode');
        apply(data, type);
    });
});
$page.onload(function() {
    var start = null;
    $('#saved-modes-panel').addEventListener('touchstart', function(e) {
        if (e.touches.length === 0) { return; }
        start = e.touches[0];
    });
    $('#saved-modes-panel').addEventListener('touchend', function(e) {
        if (e.changedTouches.length === 0) { return; }
        var end = e.changedTouches[0];
        var diff = end.screenX - start.screenX;
        start = null;

        if (diff < -50) {
            return;
        }

        var deleting = $('#saved-modes-panel #custom-modes > .saved-mode[data-remove]');
        if (deleting) {
            deleting.removeAttribute('data-remove');
        }
    });
});
$page.onload(function(e) {
    var rid = e.query.rid;

    var reload = function() {
        var modes = $db.modes[rid];
        if (!modes) {
            return $('#saved-modes-panel #custom-modes').innerHTML = '';
        }
        $('#saved-modes-panel #custom-modes').innerHTML = modes.map(function(mode) {
            var t = $templates('#saved-mode', {name: mode[0],mimg: mode[1]});
            return t;
        }).join('');
        setTimeout(function() {
            $('#saved-modes-panel #custom-modes > .saved-mode .remove', true).forEach(function(btn) {
                btn.addEventListener('touchend', function(e) {
                    $db.modes.$update(function(tbl) {
                        for (var i = 0; i < modes.length; ++i) {
                            if (modes[i][0] === $(btn.parentNode, '.name').innerHTML) {
                                modes.splice(i, 1);
                                break;
                            }
                        }
                    }).$save().then(function() {
                        reload();
                    });
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            $('#saved-modes-panel #custom-modes > .saved-mode', true).forEach(function(i, midx) {
                var start = null;
                i.addEventListener('touchstart', function(e) {
                    if (e.touches.length === 0) { return; }
                    start = e.touches[0];
                });
                i.addEventListener('touchend', function(e) {
                    if (e.changedTouches.length === 0) { return; }
                    var end = e.changedTouches[0];
                    var diff = end.screenX - start.screenX;
                    start = null;

                    if (diff < -50) {
                        var deleting = $('#saved-modes-panel #custom-modes > .saved-mode[data-remove]');
                        if (deleting) {
                            deleting.removeAttribute('data-remove');
                        }
                        return i.setAttribute('data-remove', true);
                    }

                    $db.modes[rid].forEach(function(mode) {
                        if (mode[0] !== $(i, '.name').innerHTML) { return; }
                        var records = mode[2];
                        var idx = 0;
                        var send = function() {
                            if (idx === records.length) { 
                                $app.hideIndicator();
                                return; 
                            }
                            var type = records[idx][0];
                            var mac = records[idx][1];
                            var wrgb = records[idx++][2].split(',');
                            var payload = roomViewFormat(type, mac, wrgb);
                            if (!payload) {
                                return setTimeout(send, 0);
                            }
                            $gateway.set(mac, payload).then(send)
                                .catch(function(e) {
                                    $app.alert(e, mac); 
                                    send();                           
                                });
                        };
                        send();
                        $app.showIndicator();
                    });
                });
            });
        }, 0);
    };
    $('#confirm-new-mode').addEventListener('touchend', function() {
        var name = $('#new-mode-name').value;
        if (!name) {
            return;
        }

        var mimg = $('.mode-image[data-active]');
        var icons = $(e.container, '.device-icon', true);
        var mode = icons.map(function(c) {
            var type = c.getAttribute('data-type');
            var mac = c.getAttribute('data-mac');
            var val = c.getAttribute('data-value');
            return [type, mac, val];
        });

        $db.modes.$update(function(tbl) {
            ((tbl[rid]) || (tbl[rid] = [])).push([name, mimg.id, mode]);
        }).$save().then(reload);
    });

    $('.mode-image', true).forEach(function(icn) {
        icn.addEventListener('touchend', function() {
            $('.mode-image', true).forEach(function(i) {
                if (icn === i) { i.setAttribute('data-active', true); }
                else           { i.removeAttribute('data-active'); }
            });
        });
    });

    $('#add-new-mode').addEventListener('touchend', function() {
        $('.mode-image', true).forEach(function(i, idx) {
            if (idx === 0) { i.setAttribute('data-active', true); }
            else           { i.removeAttribute('data-active'); }
        });
        $('#add-mode-group').setAttribute('data-enable', true);
        $('#new-mode-name').value = '';
        $('#new-mode-name').focus();
    });

    $('#confirm-new-mode').addEventListener('touchend', function() {
        $('#add-mode-group').removeAttribute('data-enable');
    });
    $('#cancel-new-mode').addEventListener('touchend', function() {
        $('#add-mode-group').removeAttribute('data-enable');
    });

    reload();
});

</script>

<div class='strings'>
<span id='mode-name-prompt' data-i18n-key='mode-name-prompt'></span>
</div>

<style>
    .device-icon canvas { 
        width: 90%;
        height: 90%;
        position: absolute;
        left: 5%;
        top: 5%;
    }
</style>

<script id="device-icon-light_wrgb" type="text/template7"><a class='device-icon open-picker' data-type='{{type}}' data-picker='#picker-lighting' data-value='{{levelW}},{{levelR}},{{levelG}},{{levelB}},' data-mac='{{mac}}' id='m_{{mac}}' data-new>
<!-- <i class='fa fa-superpowers' aria-hidden="true" style='color:rgb({{levelW}}%,{{levelW}}%,{{levelW}}%)'></i> -->
<!-- <span class='center' style='background:rgb({{levelR}}%,{{levelG}}%,{{levelB}}%)'></span> -->
<canvas></canvas>
</a></script>
<script id="device-icon-light_wy" type="text/template7"><a class='device-icon open-picker' data-type='{{type}}' data-picker='#picker-lighting' data-value='{{levelW}},,,,{{levelY}}' data-mac='{{mac}}' id='m_{{mac}}' data-new>
<!-- <i class='fa fa-superpowers' aria-hidden="true" style='color:rgb({{levelW}}%,{{levelW}}%,{{levelW}}%)'></i> -->
<!-- <span class='center' style='background:hsl(58,100%,{{levelY}}%)'></span> -->
<canvas></canvas>
</a></script>
<script id="device-icon-ac_switch" type="text/template7"><a class='device-icon' data-type='{{type}}' data-value='{{enable}}' data-mac='{{mac}}' id='m_{{mac}}' data-new>
<!-- <i class="fa fa-power-off" style='color:rgb({{enable}}00%, {{enable}}00%, {{enable}}00%)'></i> -->
<!-- <img src='img/icons/fmdg_16.png'> -->
<canvas></canvas>
</a></script>
<script id="saved-mode" type="text/template7"><!-- 
 --><a class='saved-mode' data-empty='true'><!-- 
     --><i style='background-image: url(img/icons/{{mimg}}.png)'></i><span data-i18n-key='custom-mode' class='name'>{{name}}</span><!-- 
     --><i class='remove icon f7-icons'>close</i><!--
 --></a>
</script>

<div class="navbar">
    <div class="navbar-inner">
        <div class="left"><a class='link' id='back-to-list' href='pages/room-list.html'><i class='icon f7-icons'>chevron_left</i><span data-i18n-key='back'></span></a></div>
        <div class="center" id='room-name'></div>
        <div class="right">
            <a class='link' href='pages/new-room.html' id='open-room-setting'><i class='icon f7-icons'>gear</i></a>
            <a class='link open-picker' data-picker='#edit-done-panel' href='#' id='enable-edit'><i class='icon f7-icons'>data</i></a>
        </div>
    </div>
</div>

<div class='page-content' style='overflow-y: auto'>

    <div class='strings'>
        <span id='remove-device-confirm-title' data-i18n-key='remove-device-confirm-title'></span>
        <span id='remove-device-confirm' data-i18n-key='remove-device-confirm'></span>
        <span id='remove-confirm' data-i18n-key='remove-confirm'></span>
        <span id='remove-cancel' data-i18n-key='remove-cancel'></span>
    </div>

    <div id='room-grid-outer'><table id='room-grid'></table></div>
    <a id='show-saved-modes' class='button button-fill open-picker' data-picker='#saved-modes-panel'><i class='icon f7-icons'>filter-fill</i></a>

    <div class='picker-modal' id='picker-lighting'><div class="picker-modal-inner"><div class="content-block">
        <div class='list-block optional-picker' id='color-picker'>
            <div><img src='img/rgb3.png'></div>
            <div id='current-color' data-i18n-key='current'></div>
            <div class='predefined-colors'>
                <span data-color='45,203,114'></span>
                <span data-color='255,0,248'></span>
                <span data-color='62,167,248'></span>
                <span data-color='138,0,255'></span>
                <span data-color='220,232,0'></span>
                <span data-color='5,241,196'></span>
                <span data-color='65,0,255'></span>
                <span data-color='0,255,11'></span>
                <span data-color='255,0,0'></span>
                <span data-color='0,255,255'></span>
            </div>
        </div>
        <div class='list-block optional-picker' id='temperature-picker'>
            <div><img src='img/wy.png'></div>
            <div id='current-temperature' data-i18n-key='current'></div>
        </div>
        <div class='list-block'>
            <div class='item-label' data-i18n-key='brightness'></div>
            <div class="item-input">
                <div class="range-slider">
                    <input id='level-slider' type="range" min="0" max="100" step="1">
                </div>
            </div>
        </div>
        <div class='list-block'>
            <div class='buttons-row'>
            <a href="#" id='lighting-apply-all' class="button button-raised link" data-i18n-key='apply-all'></a>
            <a href="#" id='lighting-toggle' class="button button-raised link"></a>
            <a href="#" id='lighting-done' class="close-picker button button-raised link" data-i18n-key='done'></a>
            </div>
        </div>
    </div></div></div>

    <style>
        #add-mode {
            position: relative;
        }
        #add-mode #confirm-new-mode {
            position: absolute;
            right: 0px;
            color: lightgreen;
            display: none;
            background-color: transparent !important;
        }
        #add-mode #cancel-new-mode {
            position: absolute;
            left: 0px;
            color: red;
            display: none;
            background-color: transparent !important;
        }
        #add-mode #new-mode-name {
            width: 0px;
            padding: 0px;
            margin: 0px;
            background: white;
            border: 1px solid #FFF;
            color: darkgray;
            border: none;
            -webkit-transition: width 0.3s;
            transition: width 0.3s;
        }
        #add-mode-group {
            height: 54px;
        }
        #add-mode-group[data-enable] {
            height: auto;
        }
        #add-mode-group .mode-image {
            display: none;
            width: 54px;
            height: 54px;
            border-radius: 54px;
            margin: 8px 4px;
            background-color: rgba(91, 142, 236, 0.2);
            background-size: 40px;
            background-repeat: no-repeat;
            background-position: center;
        }
        #add-mode-group .mode-image[data-active] {
            background-color: rgb(91, 142, 236);   
        }
        #add-mode-group .mode-image-list {
            margin: 8px 15px;
            text-align: center;
        }

        .saved-mode-group[data-enable=true] {
            padding: 16px;
            margin: 15px 15px;
            background: #F8F8F8;
            border-radius: 12px;
            box-shadow: 0px 0px 4px 4px rgba(91, 142, 236, 0.2);
        }
        .saved-mode-group[data-enable=true] .mode-image {
            display: inline-block !important;
        }
        .saved-mode-group[data-enable=true] #add-mode {
            margin: 0px 15px !important;
        }
        .saved-mode-group[data-enable=true] #add-mode #add-new-mode { display: none; }
        .saved-mode-group[data-enable=true] #add-mode #cancel-new-mode,
        .saved-mode-group[data-enable=true] #add-mode #confirm-new-mode {
            display: block;
        }
        .saved-mode-group[data-enable=true] #add-mode #new-mode-name {
            width: calc(100% - 108px);
            font-size: 32px;
            border-radius: 100px;
            padding: 11px 54px;
            line-height: 32px;
            height: 32px;
            border: 1px solid #DDD;
        }
        .mode-image#cj_07 {
            background-image: url(img/icons/cj_07.png);
        }
        .mode-image#cj_10 {
            background-image: url(img/icons/cj_10.png);
        }
        .mode-image#cj_13 {
            background-image: url(img/icons/cj_13.png);
        }
        .mode-image#cj_16 {
            background-image: url(img/icons/cj_16.png);
        }
        .mode-image#cj_22 {
            background-image: url(img/icons/cj_22.png);
        }
    </style>

    <div class='picker-modal' id='saved-modes-panel'><div class='picker-modal-inner'>
        <a href="#" id='close-saved-modes-panel' class="close-picker link"><i class='icon f7-icons'>chevron_down</i></a>
        <div><!-- 
     --><span class='saved-mode-group' id='add-mode-group'><!--
        --><div class='mode-image-list'><!--
            --><span id='cj_07' class='mode-image'></span><!-- 
            --><span id='cj_10' class='mode-image'></span><!-- 
            --><span id='cj_13' class='mode-image'></span><!-- 
            --><span id='cj_16' class='mode-image'></span><!-- 
            --><span id='cj_22' class='mode-image'></span><!-- 
        --></div><!--
        --><a id='add-mode' class='saved-mode'><!-- 
        --><i id='cancel-new-mode' class='icon f7-icons'>close</i><!--
        --><i id='confirm-new-mode' class='icon f7-icons'>check</i><!--
        --><i id='add-new-mode' class='icon f7-icons'>add</i><input id='new-mode-name'><!-- 
        --></a><!--         
     --></span><!-- 
     --><span class='saved-mode-group' id='custom-modes'></span><!-- 
     --><span class='saved-mode-group'><!-- 
        --><a id='all-on' class='saved-mode' data-value='100,,,,'><i class="fa fa-power-off"></i><span data-i18n-key='all-on'></span></a><!-- 
        --><a id='all-off' class='saved-mode' data-value='0,,,,'><i class="fa fa-power-off"></i><span data-i18n-key='all-off'></span></a>
        </span><!-- 
     --></div>
    </div></div>

    <div class="picker-modal" id='edit-done-panel'><div class='picker-modal-inner'><div class='content-block'>
        <a href="#" id='edit-done' class="close-picker button button-fill button-raised link" data-i18n-key='done'></a>
    </div></div></div>
</div>

</div>